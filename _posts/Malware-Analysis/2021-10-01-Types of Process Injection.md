---
title:   Types of Process Injection
classes: wide
header:
  teaser: /img/process.PNG
ribbon: red
categories:
  - Malware-Analysis
toc: true
---

# Process Injection

Process injection is a common Evasion tactic that used by malware authors in order to hide malicious code into legitimate processes and execute it on a system, also allow malware to gain access to other processes.

Attackers can employ a number of techniques in order to accomplish process injection, including spawning new processes in a suspended state, allocating memory within them, and then writing malicious code into this created memory space (process hollowing), or injecting a thread into an existing process.

Some of these techniques can be inferred by the presence of certain API calls within the binary.
The API calls are listed here:

* VirtualAllocEx
* WriteProcessMemory
* CreateRemoteThread
* NtCreateThreadEx
* QueueThreadAPC
Any combination of these APIs, in combination with APIs such as CreateToolHelp32Snapshot, should be viewed as a suspect. It's likely the sample is enumerating running processes in order to iterate through and find the process they would like to utilize as a target for process injection.

<!-- more -->

# Types of Process Injection 

 Although there are myriad different ways with technical differences involved in calling the APIs and injecting into processes. Only fundamental Process Injecction techniques are discussed right now.

# Classic DLL injection

DLL-Injection is the most common technique that used by malware to inject malicious code into other processes to evade detection, and every processes need to load dynamic link Libraries to work, So it became easy to load malicious code in legitimate processes. 

In classic DLL injection, the malicious process will often utilize CreateToolHelp32Snapshot in order to iterate through processes until it locates the process it would like to target. Once located, the malicious process will utilize VirtualAlloc and WriteProcessMemory to write the path for a malicious DLL into the virtual address space of the target process.
![Classic Dll Injection](https://user-images.githubusercontent.com/73170547/139692755-76c5aea0-e99f-446d-a330-ca1a4c35d4fd.png)


Once the DLL's path is written into the virtual memory space of the target process, the malicious process will utilize CreateRemoteThread in order to force the process to load the malicious library.

# PE Injection
This technique is highly similar to classic DLL injection.

![PE Injection](https://user-images.githubusercontent.com/73170547/139692880-f5a24c8f-77dd-4136-b96f-503ef2961ad8.png)

Instead of injecting the path to the DLL into the virtual memory of the process, the malware will create address space utilizing VirtualAlloc, then write a PE directly into the memory address space using WriteProcessMemory, and ensure code execution by utilizing CreateRemoteThread or similar undocumented APIs such as NTCreateThreadEx.

# Thread execution hijacking
In this technique, the malware will suspend an existing thread of a process. 

![Thread Hijack](https://user-images.githubusercontent.com/73170547/139693329-ccdaf1ed-befa-4323-908b-869e2d01e33f.png)


First, the malware will suspend the thread, utilize VirtualAlloc to clear memory space for the path of the DLL, and inject the path to the DLL and a call to LoadLibrary in order to load the malicious DLL into the existing thread in the process. The malware will then instruct the thread to resume.

# Process hollowing
In Process hollowing the malicious process will spawn a legitimate process in a suspended state and will then unmap the legitimate code from the process utilizing VirtualAlloc. The code within the process will then be replaced with malicious code utilizing WriteProcessMemory, and the process will be resumed.

![image](https://user-images.githubusercontent.com/73170547/139693420-b19483b5-989b-432b-9f60-ea16d0da5feb.png)





## References

* Malware-Analysis-Techniques By Dylan Barke [Check it Out](https://www.packtpub.com/product/malware-analysis-techniques/9781839212277)
* https://www.elastic.co/blog/ten-process-injection-techniques-technical-survey-common-and-trending-process











 



